steps:
- script: |
    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
    cd src/terraform/examples/vfxt/${RUN_TERRAFORM_FILE}
    CONTROLLER_ADDRESS=$(terraform output -json | jq -r ".controller_address.value")
    USERNAME=$(terraform output -json | jq -r ".controller_username.value")

    echo "##vso[task.setvariable variable=secret.PUBLIC_KEY;issecret=true]${PUBLIC_KEY}"
    echo "ssh-rsa ${PUBLIC_KEY}" >> /home/$USERNAME/.ssh/authorized_keys
    ssh ${USERNAME}@${CONTROLLER_ADDRESS} "echo \"$PUBLIC_KEY\" >> /home/$USERNAME/.ssh/authorized_keys"
  displayName: 'Pass in public ssh key'