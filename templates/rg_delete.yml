steps:
- bash: |
    # Resource group deletes are sometimes failing for reasons outside of
    rg_del_rc=111111
    for i in "-vfxt" "-filer" "-storage" "-proxy" "-network"; do  
      exists=$(az group exists --name ${RESOURCE_GROUP_NAME}$i)
      if [ $exists = "true" ]; then
        for i in {1..3}; do
          az group delete --yes --name ${RESOURCE_GROUP_NAME}$i --subscription ${ARM_SUBSCRIPTION_ID}
          rg_del_rc=$?
          if [ "${rg_del_rc}" -ne 0 ]; then
            echo "##vso[task.logissue type=warning;]Deleting resource group ${RESOURCE_GROUP_NAME}$i failed. Attempt $i of 3."
          else
            break
          fi
        done
      fi
    done

    if [ "${rg_del_rc}" -ne 0 ]; then
      echo "##vso[task.logissue type=error;]Deleting resource group failed. See log for details."
      echo "##vso[task.complete result=Failed;]"
      echo "##vso[build.addbuildtag]FAIL RG_cleanup"
    else
      echo "Resource groups successfully deleted."
    fi
  displayName: 'CLEANUP: Delete resource group'
  condition: always()
