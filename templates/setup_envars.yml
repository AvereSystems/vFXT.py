# Copyright (C) Microsoft Corporation. All rights reserved.
# https://aka.ms/yaml
parameters:
- name: run_terraform
  type: string
- name: region
  type: string

steps:
- bash: |
    resource_group="tf$(date -u +'%m%dx%H%M%S')"
    echo "##vso[task.setvariable variable=REGION]${{ parameters.region }}"
    echo "##vso[task.setvariable variable=RESOURCE_GROUP_NAME]${resource_group}"
    echo "##vso[task.setvariable variable=RUN_TERRAFORM_FILE]${{ parameters.run_terraform }}"
    
    echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID;isSecret=true]${ARM_SUBSCRIPTION_ID}"
    echo "##vso[task.setvariable variable=ARM_CLIENT_ID;isSecret=true]${ARM_CLIENT_ID}"
    echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET;isSecret=true]${ARM_CLIENT_SECRET}"
    echo "##vso[task.setvariable variable=ARM_TENANT_ID;isSecret=true]${ARM_TENANT_ID}"
    az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
  displayName: "Setup: Credentials and Environment Variables"
  condition: always()
  env: 
    ARM_CLIENT_ID: $(AZURE-CLIENT-ID)
    ARM_CLIENT_SECRET: $(AZURE-CLIENT-SECRET)
    ARM_TENANT_ID: $(AZURE-TENANT-ID)
    ARM_SUBSCRIPTION_ID: $(AZURE-SUBSCRIPTION-ID)
