parameters:
- name: run_terraform
  type: string
  default: ''
- name: original_node_count
  type: string
- name: scale_up_node_count
  type: string
- name: scale
  type: string
  values:
  - "up"
  - "down"

steps:
- script: |
    cd src/terraform/examples/vfxt/${RUN_TERRAFORM_FILE}
    sed -i "s/storage_account_name = \"storageaccount\"/storage_account_name = \"$RESOURCE_GROUP_NAME\"/" main.tf
  displayName: 'Terraform: setup ${{ parameters.run_terraform }}'
  condition: not(or(eq('${{ parameters.scale }}', 'up'), eq('${{ parameters.scale }}', 'down')))

- script: |
    cd src/terraform/examples/vfxt/${RUN_TERRAFORM_FILE}
    export new_node_count=$(( ${{ parameters.original_node_count }} + ${{ parameters.scale_up_node_count }} ))
    if [ "up" = "${{ parameters.scale }}" ]; then
      sed -i "s/vfxt_node_count = ${{ parameters.original_node_count }}/vfxt_node_count = ${new_node_count}/" main.tf
    elif [ "down" = "${{ parameters.scale }}" ]; then
      sed -i "s/vfxt_node_count = ${new_node_count}/vfxt_node_count = ${{ parameters.original_node_count }}/" main.tf
    fi
  displayName: 'Terraform: setup scale ${{ parameters.scale }} '
  condition: or(eq('${{ parameters.scale }}', 'up'), eq('${{ parameters.scale }}', 'down'))