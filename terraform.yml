jobs:
- job: Terraform_example
  timeoutInMinutes: 60
  pool:
    vmImage: ubuntu-latest
  steps:  
  - script: |
      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
      wget https://releases.hashicorp.com/terraform/0.12.25/terraform_0.12.25_linux_amd64.zip
      unzip terraform_0.12.25_linux_amd64.zip
      sudo mv terraform /usr/local/bin
      sudo chmod 755 /usr/local/bin/terraform
      
      export RESOURCE_GROUP_NAME="tf$(date -u +'%m%dx%H%M%S')"
      export REGION=westus
      cd src/terraform/examples/resource-group
      terraform init 
      terraform apply -auto-approve -var="rg_name=${RESOURCE_GROUP_NAME}" \
        -var="rg_location=${REGION}" 

      terraform destroy -auto-approve -var="rg_name=${RESOURCE_GROUP_NAME}" \
        -var="rg_location=${REGION}" 
    displayName: 'TEST: test'
    condition: always()
    env:
      ARM_TENANT_ID: $(AZURE-TENANT-ID)
      ARM_CLIENT_ID: $(AZURE-CLIENT-ID)
      ARM_CLIENT_SECRET: $(AZURE-CLIENT-SECRET)
      AZURE_SUBSCRIPTION_ID: $(AZURE-SUBSCRIPTION-ID)
