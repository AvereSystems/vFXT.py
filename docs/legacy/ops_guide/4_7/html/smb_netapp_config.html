
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Appendix F: Configuring NetApp Filers for Avere SMB ACLs &#8212; Avere OS Configuration Guide</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

   <!-- use for draft review builds only - enables web page annotation internally -->
<!--
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script src="_static/annotator-full.min.js"></script>
    <script src="_static/annotate_init.js"></script>
    <link rel="stylesheet" href="_static/annotator.min.css">
-->

  </head><body>

<a href="https://azure.github.io/Avere/">
	<img style="margin: 20px; width: 40%;" src="_static/avere-microsoft-logo-full.png">
  </a>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="ops_conf_index.html">Avere OS Configuration Guide</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="appendix-f-configuring-netapp-filers-for-avere-smb-acls">
<span id="smb-netapp"></span><h1>Appendix F: Configuring NetApp Filers for Avere SMB ACLs<a class="headerlink" href="#appendix-f-configuring-netapp-filers-for-avere-smb-acls" title="Permalink to this headline">     </a></h1>
<p>This document explains how to configure NetApp storage to support ACL-based security for SMB when used with an Avere cluster. It also gives more detail about the steps needed to set up and use SMB with an Avere cluster and a NetApp filer.</p>
<p>The specific steps are different depending on whether your NetApp filer uses Clustered Data ONTAP or Data ONTAP in 7-Mode. After reading the prerequisite sections, be sure to read the correct steps for your system:</p>
<ul class="simple">
<li><a class="reference internal" href="#smb-ntap-clustered"><span class="std std-ref">SMB Setup - Clustered Data ONTAP</span></a></li>
<li><a class="reference internal" href="#smb-ntap-7mode"><span class="std std-ref">SMB Setup - Data ONTAP 7-Mode</span></a></li>
</ul>
<div class="section" id="netapp-filer-requirements-for-smb-acl-support">
<span id="smb-ntap-requirements"></span><h2>NetApp Filer Requirements for SMB ACL Support<a class="headerlink" href="#netapp-filer-requirements-for-smb-acl-support" title="Permalink to this headline">     </a></h2>
<p>The following constraints apply to SMB/CIFS ACL support when using an Avere cluster with a NetApp Data ONTAP network-attached storage system.</p>
<p>[ xxx adapted from a c-mode requirements list - what is wrong or missing for 7-mode? xxx ]</p>
<ul class="simple">
<li>Data ONTAP version:<ul>
<li>For Clustered Data ONTAP, version 8.3.1 or higher is required.</li>
<li>For 7-Mode Data ONTAP, version 7.* or higher is required. [ xxx double check? xxx ]</li>
</ul>
</li>
<li>Only NetApp “NTFS” security style is supported (mixed mode is unsupported).</li>
<li>Native Identity is required. (If username download is configured on the Avere cluster, you can use a separate vserver for ACL support.) [ xxx is this for clustered only? xxx ]</li>
<li>Username download on the NetApp core filer is optional. [ xxx clustered only or both? xxx]</li>
</ul>
<p>All general NFS export requirements must be met - for example, the filer export rules must allow root access for the Avere cluster and client facing addresses. [ xxx does previous sentence apply for 7-mode? xxx ] For clustered Data ONTAP, remember that each volume can have a different export policy, so you might need to update multiple policies and not just the policy associated with the root volume.</p>
<p>Note that Avere SMB/CIFS ACL migration requirements require a core filer SMB share that provides access to the NFS export <code class="docutils literal notranslate"><span class="pre">/</span></code>.</p>
</div>
<div class="section" id="steps-to-take-before-configuring-smb">
<span id="smb-ntap-preconfig"></span><h2>Steps To Take Before Configuring SMB<a class="headerlink" href="#steps-to-take-before-configuring-smb" title="Permalink to this headline">     </a></h2>
<p>This document assumes that Avere cluster setup is complete and the cluster is up and running in a good state. Also, make sure that these elements are in place:</p>
<ul class="simple">
<li>The cluster should be configured for multiprotocol access, with an LDAP server and Active Directory system set up and configured with the correct user and group information. Read <a class="reference internal" href="smb_ad_admin_guide.html#smb-ad-admin"><span class="std std-ref">Appendix F: Configuring Active Directory for Avere SMB</span></a> for more details.</li>
<li>Needed ports must be open to the Active Directory environment. [ xxx ports on the Avere cluster? Where is this configured, in vserver config or somewhere else? xxx ]</li>
<li>The cluster network must be configured with a working gateway and at least one NTP server.</li>
<li>The cluster must have an SMB-enabled vserver with a client-facing network set up.
[ xxx does this apply to 7-mode? xxx ]</li>
</ul>
<div class="section" id="about-netapp-filer-language-settings">
<span id="ntap-vol-language"></span><h3>About NetApp Filer Language Settings<a class="headerlink" href="#about-netapp-filer-language-settings" title="Permalink to this headline">     </a></h3>
<p>The NetApp filer must use UTF-8 encoding and have volume language settings correctly configured before using it with ACL-controlled SMB shares through an Avere cluster. This configuration is especially critical if any filenames on the volume include multi-byte (non-ASCII) characters.</p>
<p>Incorrect language settings can cause the Avere cluster to see different filenames for a single file when accessing the file with NFS and with SMB. By default, SMB client communications always use UTF-16 encoding for filenames, but NFS communications use the encoding that corresponds to the volume’s locale and language setting. Even if you do not have any NFS clients accessing the core filer through your Avere cluster, the cluster itself can make NFS requests.</p>
<p>Having multiple different filenames interferes with ACL evaluation and disrupts caching algorithms.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">create_ucode</span></code> and <code class="docutils literal notranslate"><span class="pre">convert_ucode</span></code> options can be enabled on NetApp volumes to help reduce computational load on the core filer if filenames must be translated between UTF-16 and UTF-8.</p>
<p>NetApp’s <a class="reference external" href="http://kb.netapp.com/support/s/article/ka21A0000000bH2QAI/how-does-the-volume-language-work-with-the-storage-system/">knowledge base article number 000002412</a> explains how volume language affects the storage system.</p>
<p>When setting up each NetApp volume for SMB access, check the language settings on the volume and adjust them if necessary. Also consider enabling the create_ucode and convert_ucode options.</p>
<p>The following examples show how to check and configure language settings on a NetApp volume named <code class="docutils literal notranslate"><span class="pre">vol0</span></code>.</p>
<p>Checking and setting the volume language:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netapp</span><span class="o">&gt;</span> <span class="n">vol</span> <span class="n">lang</span> <span class="n">vol0</span>
<span class="n">Volume</span> <span class="n">language</span> <span class="ow">is</span> <span class="n">undefined</span> <span class="mi">0</span> <span class="p">(</span><span class="n">undefined</span><span class="p">)</span>

<span class="n">netapp</span><span class="o">&gt;</span> <span class="n">vol</span> <span class="n">lang</span> <span class="n">vol0</span>  <span class="n">en_US</span><span class="o">.</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<span class="n">The</span> <span class="n">new</span> <span class="n">language</span> <span class="n">mappings</span> <span class="n">will</span> <span class="n">be</span> <span class="n">available</span> <span class="n">after</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>Setting ucode options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netapp</span><span class="o">&gt;</span> <span class="n">vol</span> <span class="n">options</span> <span class="n">vol0</span>
<span class="n">nosnap</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">nosnapdir</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">minra</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">no_atime_update</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">nvfail</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">ignore_inconsistent</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">snapmirrored</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">create_ucode</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">convert_ucode</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">maxdirsize</span><span class="o">=</span><span class="mi">5242</span><span class="p">,</span> <span class="n">schedsnapname</span><span class="o">=</span><span class="n">ordinal</span><span class="p">,</span>
<span class="n">fs_size_fixed</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">guarantee</span><span class="o">=</span><span class="n">none</span><span class="p">,</span> <span class="n">svo_enable</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">svo_checksum</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">svo_allow_rman</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">svo_reject_errors</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">no_i2p</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">fractional_reserve</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">try_first</span><span class="o">=</span><span class="n">volume_grow</span><span class="p">,</span>
<span class="n">snapshot_clone_dependency</span><span class="o">=</span><span class="n">off</span>

<span class="n">netapp</span><span class="o">&gt;</span> <span class="n">vol</span> <span class="n">options</span> <span class="n">vol0</span> <span class="n">create_ucode</span> <span class="n">on</span>

<span class="n">netapp</span><span class="o">&gt;</span> <span class="n">vol</span> <span class="n">options</span> <span class="n">vol0</span> <span class="n">convert_ucode</span> <span class="n">on</span>

<span class="n">netapp</span><span class="o">&gt;</span> <span class="n">vol</span> <span class="n">options</span> <span class="n">vol0</span>
<span class="n">nosnap</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">nosnapdir</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">minra</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">no_atime_update</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">nvfail</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">ignore_inconsistent</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">snapmirrored</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">create_ucode</span><span class="o">=</span><span class="n">on</span><span class="p">,</span>
<span class="n">convert_ucode</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="n">maxdirsize</span><span class="o">=</span><span class="mi">5242</span><span class="p">,</span> <span class="n">schedsnapname</span><span class="o">=</span><span class="n">ordinal</span><span class="p">,</span>
<span class="n">fs_size_fixed</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">guarantee</span><span class="o">=</span><span class="n">none</span><span class="p">,</span> <span class="n">svo_enable</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">svo_checksum</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">svo_allow_rman</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">svo_reject_errors</span><span class="o">=</span><span class="n">off</span><span class="p">,</span>
<span class="n">no_i2p</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">fractional_reserve</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">off</span><span class="p">,</span> <span class="n">try_first</span><span class="o">=</span><span class="n">volume_grow</span><span class="p">,</span>
<span class="n">snapshot_clone_dependency</span><span class="o">=</span><span class="n">off</span>
</pre></div>
</div>
<p>[ xxx a lot more details in Trac 23558 but I’m not sure it’s needed - ? xxx ]</p>
<p>Note that a core filer reboot is recommended after changing volume language settings.</p>
</div>
</div>
<div class="section" id="smb-setup-clustered-data-ontap">
<span id="smb-ntap-clustered"></span><h2>SMB Setup - Clustered Data ONTAP<a class="headerlink" href="#smb-setup-clustered-data-ontap" title="Permalink to this headline">     </a></h2>
<p>This example walks through initial SMB configuration for a NetApp core filer that uses clustered Data ONTAP and SMB ACLs.</p>
<p>To configure a system that uses 7-mode, read <a class="reference internal" href="#smb-ntap-7mode"><span class="std std-ref">SMB Setup - Data ONTAP 7-Mode</span></a>.</p>
<p>This document assumes that the Avere cluster meets the requirements outlined in <a class="reference internal" href="#smb-ntap-requirements"><span class="std std-ref">NetApp Filer Requirements for SMB ACL Support</span></a> and <a class="reference internal" href="#smb-ntap-preconfig"><span class="std std-ref">Steps To Take Before Configuring SMB</span></a>.</p>
<p>Also, do not add the NetApp core filer to the cluster until after you have checked its configuration as described in <a class="reference internal" href="#ntap-filer-config-clustered"><span class="std std-ref">3. Verify the NetApp Filer Configuration</span></a>.</p>
<p>These are the steps needed to set up SMB with an Avere cluster and a NetApp clustered system:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#ntap-configure-ad-clustered"><span class="std std-ref">Configure cluster directory services</span></a></li>
<li><a class="reference internal" href="#ntap-vserver-config-clustered"><span class="std std-ref">Configure SMB on the Cluster VServer</span></a></li>
<li><a class="reference internal" href="#ntap-filer-config-clustered"><span class="std std-ref">Check the Configuration of the NetApp Filer</span></a></li>
<li><a class="reference internal" href="#ntap-delegation"><span class="std std-ref">Set up Constrained Delegation</span></a></li>
<li><a class="reference internal" href="#ntap-add-core-filer"><span class="std std-ref">Add the NetApp System as a Cluster Core Filer</span></a></li>
<li><a class="reference internal" href="#ntap-add-junction"><span class="std std-ref">Add a Namespace Junction to the NetApp SMB Volume</span></a></li>
<li><a class="reference internal" href="#ntap-add-share"><span class="std std-ref">Add the SMB Shares to the Avere Cluster</span></a></li>
<li><a class="reference internal" href="#ntap-share-ace"><span class="std std-ref">Configure share permissions</span></a></li>
</ol>
<div class="section" id="configure-directory-services">
<span id="ntap-configure-ad-clustered"></span><h3>1. Configure Directory Services<a class="headerlink" href="#configure-directory-services" title="Permalink to this headline">     </a></h3>
<p>Make sure that the Avere cluster has the correct Active Directory configuration.</p>
<p>Use the <span class="guilabel">Cluster &gt; Directory Services</span> settings page to modify the cluster’s directory services configuration. Click on the name <span class="guilabel">default</span> to view or modify the settings.</p>
<a class="reference internal image-reference" href="_images/ntap_smb_dirsvc.png"><img alt="Directory Services configuration list" src="_images/ntap_smb_dirsvc.png" style="width: 60%;" /></a>
<p>Make sure that these two items are set in the <span class="guilabel">CIFS</span> section of the configuration:</p>
<ul class="simple">
<li>In <span class="guilabel">User/Group Name</span>, check <span class="guilabel">I don’t have any</span> for the <span class="guilabel">Source</span> value.</li>
<li>In the <span class="guilabel">Active Directory</span> section, enter your domain and click the <span class="guilabel">Lookup</span> button to validate the setting.</li>
</ul>
<a class="reference internal image-reference" href="_images/ntap_smb_dirsvc_example.png"><img alt="Detailed view of the directory services configuration settings" src="_images/ntap_smb_dirsvc_example.png" style="width: 80%;" /></a>
<p>For more information about these settings, read <a class="reference internal" href="gui_directory_services.html#gui-directory-services"><span class="std std-ref">Cluster &gt; Directory Services</span></a>.</p>
</div>
<div class="section" id="configure-smb-on-the-cluster-vserver">
<span id="ntap-vserver-config-clustered"></span><h3>2. Configure SMB on the Cluster VServer<a class="headerlink" href="#configure-smb-on-the-cluster-vserver" title="Permalink to this headline">     </a></h3>
<p>Use the <span class="guilabel">VServer &gt; CIFS</span> settings page to configure SMB on the Avere cluster’s vserver. (If you will use more than one vserver for SMB access to this core filer, repeat the vserver configuration steps for each vserver.)</p>
<a class="reference internal image-reference" href="_images/ntap_smb_vserver.png"><img alt="VServer configuration for SMB/CIFS" src="_images/ntap_smb_vserver.png" style="width: 60%;" /></a>
<p>Specifically, make the following changes:</p>
<ul class="simple">
<li>Select <span class="guilabel">Enable CIFS</span>.</li>
<li>Select <span class="guilabel">Enable SMB2</span>.</li>
<li>Specify the SMB server name.</li>
<li>Specify the AD administrative username and password. (If the admin account has no password, leave this field blank.)</li>
<li>Select <span class="guilabel">Enable Native Identity</span>.</li>
</ul>
<p>Click <span class="guilabel">Submit</span> to save the changes and turn on SMB for this vserver.</p>
<p><a class="reference internal" href="gui_cifs.html#gui-cifs"><span class="std std-ref">VServer &gt; CIFS</span></a> gives more details about this configuration page.</p>
</div>
<div class="section" id="verify-the-netapp-filer-configuration">
<span id="ntap-filer-config-clustered"></span><h3>3. Verify the NetApp Filer Configuration<a class="headerlink" href="#verify-the-netapp-filer-configuration" title="Permalink to this headline">     </a></h3>
<p>Make sure that the NetApp storage system is ready to be used with the Avere cluster for SMB.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>The Clustered Data ONTAP software version must be 8.3.1 or later.</li>
<li>The NetApp volume security style must be set to “NTFS”. (<em>Mixed</em> is <strong>not supported</strong>.)</li>
</ul>
</div>
<p>All general NFS export requirements must be met - for example, NAS core filer export rules must allow root access for cluster and client-facing addresses. Remember that each Clustered Data ONTAP volume can have a different export policy, so you might need to update multiple policies, not only the policy that is associated with the root volume.</p>
<p>Take the following steps on the NetApp system to configure it to communicate and share SMB ACLs with the Avere cluster.</p>
<ol class="arabic">
<li><p class="first">Determine the NetApp vserver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vserver</span> <span class="n">show</span> <span class="o">-</span><span class="nb">type</span> <span class="n">data</span>
</pre></div>
</div>
</li>
<li><p class="first">Create a mapping between the NFS user root and the AD domain administrator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vserver name-mapping create -vserver $&lt;VSERVER_NAME&gt; -direction unix-win
                            -position 1 -pattern ^root$
                            -replacement &quot;$&lt;DOMAIN&gt;\\Administrator&quot;
</pre></div>
</div>
</li>
<li><p class="first">Verify the mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vserver</span> <span class="n">name</span><span class="o">-</span><span class="n">mapping</span> <span class="n">show</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure NFS root user access to bypass filesystem ACL checks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>set -privilege advanced
vserver nfs modify -vserver $&lt;VSERVER_NAME&gt; -ignore-nt-acl-for-root enabled
</pre></div>
</div>
</li>
<li><p class="first">Set the default UNIX user to “root” rather than “nobody”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vserver cifs options modify -vserver $&lt;VSERVER_NAME&gt; -default-unix-user root
</pre></div>
</div>
</li>
<li><p class="first">Verify the default UNIX user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vserver cifs options show -vserver $&lt;VSERVER_NAME&gt;
</pre></div>
</div>
</li>
<li><p class="first">Determine which volume is associated with the desired path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>volume show -vserver $&lt;VSERVER_NAME&gt; $&lt;VOLUME_NAME&gt; -fields junction-path
</pre></div>
</div>
</li>
<li><p class="first">Verify that the language setting is C.UTF-8 (see <a class="reference internal" href="#ntap-vol-language"><span class="std std-ref">About NetApp Filer Language Settings</span></a> above):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>volume show -vserver $&lt;VSERVER_NAME&gt; -volume $&lt;VOLUME_NAME&gt; -fields language
</pre></div>
</div>
</li>
<li><p class="first">Verify that the volume security style is NTFS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>volume show -vserver $&lt;VSERVER_NAME&gt; -volume $&lt;VOLUME_NAME&gt; -fields security-style
</pre></div>
</div>
</li>
<li><p class="first">Determine the CIFS share name that accesses the desired path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vserver cifs share show -vserver $&lt;VSERVER_NAME&gt;
</pre></div>
</div>
</li>
<li><p class="first">Verify that the share ACL gives permissions for the desired users and for the AD domain administrator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vserver cifs share show -vserver $&lt;VSERVER_NAME&gt; $&lt;VOLUME_NAME&gt; -fields acl
</pre></div>
</div>
</li>
<li><p class="first">Determine the node that owns the volume:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>volume show -vserver $&lt;VSERVER_NAME&gt; -volume $&lt;VOLUME_NAME&gt; -fields node
</pre></div>
</div>
</li>
<li><p class="first">Verify that the ACL for the volume permits access:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vserver security file-directory show -vserver $&lt;VSERVER_NAME&gt;
                                     -volume-name $&lt;VOLUME_NAME&gt;
                                     -path $&lt;PATH&gt;
</pre></div>
</div>
</li>
</ol>
<div class="section" id="configuring-additional-volumes">
<h4>Configuring Additional Volumes<a class="headerlink" href="#configuring-additional-volumes" title="Permalink to this headline">     </a></h4>
<p>After the root volume has been correctly configured, other volumes created by using the NetApp command line interface should inherit the correct values. However, you should verify the settings on any newly created volume, since it is possible that some configuration settings might be applied improperly.</p>
<dl class="docutils">
<dt>[ xxx to do - ?</dt>
<dd>? add example exports from NetApp
? add examples of NetApp CLI output for commands above  xxx ]</dd>
</dl>
</div>
</div>
<div class="section" id="configure-constrained-delegation-in-active-directory">
<span id="ntap-delegation"></span><h3>4. Configure Constrained Delegation in Active Directory<a class="headerlink" href="#configure-constrained-delegation-in-active-directory" title="Permalink to this headline">     </a></h3>
<p>Use the Active Directory administration tool to set up permissions between the vserver on the Avere cluster and the NetApp core filer.</p>
<p>Directions are included in <a class="reference internal" href="smb_ad_admin_guide.html#smb-ad-admin"><span class="std std-ref">Appendix F: Configuring Active Directory for Avere SMB</span></a>. Read <a class="reference internal" href="smb_ad_admin_guide.html#smb-config-constrained-delegation"><span class="std std-ref">2.  Configure Kerberos Constrained Delegation</span></a>.</p>
</div>
<div class="section" id="add-the-netapp-system-as-a-core-filer-in-the-cluster-cap">
<span id="ntap-add-core-filer"></span><h3>5. Add the NetApp System as a Core Filer in the Avere Cluster<a class="headerlink" href="#add-the-netapp-system-as-a-core-filer-in-the-cluster-cap" title="Permalink to this headline">     </a></h3>
<p>Use the <span class="guilabel">Create</span> button on the <span class="guilabel">Core Filer &gt; Manage Core Filers</span> settings page to define the NetApp storage system as a core filer in the Avere cluster.</p>
<p>When creating the core filer, be sure to use fill in the <span class="guilabel">Core filer network name/IP</span> field with either the fully qualified domain name or with a NetBIOS name that maps exactly to the SPN entry for the SMB share.</p>
<a class="reference internal image-reference" href="_images/ntap_smb_add_core_filer.png"><img alt="completed New Core Filer wizard page for a NetApp core filer" src="_images/ntap_smb_add_core_filer.png" style="width: 85%;" /></a>
<p>Read <a class="reference internal" href="new_core_filer_nas.html#create-core-filer-nas"><span class="std std-ref">Adding a New Core Filer - NAS Core Filer</span></a> for details.</p>
</div>
<div class="section" id="add-a-namespace-junction-to-the-netapp-export">
<span id="ntap-add-junction"></span><h3>6. Add a Namespace Junction to the NetApp Export<a class="headerlink" href="#add-a-namespace-junction-to-the-netapp-export" title="Permalink to this headline">     </a></h3>
<p>Use the <span class="guilabel">VServer &gt; Namespace</span> settings page to create a new junction that maps the NetApp core filer to the client namespace on the Avere cluster.</p>
<a class="reference internal image-reference" href="_images/ntap_smb_junction.png"><img alt="filling out the new junction dialog for a NetApp SMB core filer" src="_images/ntap_smb_junction.png" style="width: 80%;" /></a>
<p>If SMB options do not show, click the checkbox labeled <span class="guilabel">Advanced</span>.</p>
<p>When creating the junction, make sure you fill in these fields correctly:</p>
<ul class="simple">
<li>In the <span class="guilabel">CIFS access control</span> field, choose <span class="guilabel">CIFS ACLs</span>.</li>
<li>In the <span class="guilabel">Core filer share name</span> field, specify the SMB share name that corresponds to the share on the NetApp system.</li>
</ul>
<p>Read <a class="reference internal" href="gui_namespace.html#create-junction"><span class="std std-ref">Creating A Junction</span></a> in <a class="reference internal" href="gui_namespace.html#gui-namespace"><span class="std std-ref">VServer &gt; Namespace</span></a> for more details.</p>
</div>
<div class="section" id="add-an-smb-share-on-the-cluster-cap">
<span id="ntap-add-share"></span><h3>7. Add an SMB Share on the Avere Cluster<a class="headerlink" href="#add-an-smb-share-on-the-cluster-cap" title="Permalink to this headline">     </a></h3>
<p>Use the <span class="guilabel">VServer &gt; CIFS Shares</span> settings page to create a share on the Avere cluster that will communicate with the back-end SMB share on the NetApp system.</p>
<a class="reference internal image-reference" href="_images/ntap_smb_share.png"><img alt="Form for adding an SMB share" src="_images/ntap_smb_share.png" style="width: 80%;" /></a>
<p>In the <span class="guilabel">Namespace path</span> field, enter the same path that you used in creating the junction in step 8.</p>
<p>Read <a class="reference internal" href="gui_cifs_shares.html#gui-cifs-shares"><span class="std std-ref">VServer &gt; CIFS Shares</span></a> for details.</p>
</div>
<div class="section" id="configure-share-permissions">
<span id="ntap-share-ace"></span><h3>8. Configure Share Permissions<a class="headerlink" href="#configure-share-permissions" title="Permalink to this headline">     </a></h3>
<p>To configure share-level permissions, use the <span class="guilabel">VServer &gt; CIFS Shares</span> page in the Settings tab. Find the SMB share that you want to review or modify, and click its name to load its share details page.</p>
<p>A list of access control entries for the share appears at the bottom of the share details page.</p>
<a class="reference internal image-reference" href="_images/cifs_share_detail.png"><img alt="Share details page" src="_images/cifs_share_detail.png" style="width: 85%;" /></a>
<p>Click the <span class="guilabel">Modify</span> button to update the share permissions.</p>
<a class="reference internal image-reference" href="_images/gui_smb_share_acl_add.png"><img alt="Modifying an SMB share ACE" src="_images/gui_smb_share_acl_add.png" style="width: 85%;" /></a>
<p>Read <a class="reference internal" href="gui_cifs_shares.html#gui-smb-share-acls"><span class="std std-ref">Share-Level Access Control Lists (ACLs)</span></a> for information about the values that are supported.</p>
</div>
</div>
<div class="section" id="smb-setup-data-ontap-7-mode">
<span id="smb-ntap-7mode"></span><h2>SMB Setup - Data ONTAP 7-Mode<a class="headerlink" href="#smb-setup-data-ontap-7-mode" title="Permalink to this headline">     </a></h2>
<p>[ xxx can this follow the same steps as for clustered mode, above? things like adding the core filer and creating the junction should be identical, right?</p>
<p>I will make this draft try to fit that structure &amp; see if it works.</p>
<p>Cluster mode steps:</p>
<ul class="simple">
<li>Configure cluster directory services</li>
<li>Configure SMB on the Cluster VServer</li>
<li>Check the Configuration of the NetApp Filer</li>
<li>Set up Constrained Delegation</li>
<li>Add the NetApp System as a Cluster Core Filer</li>
<li>Add a Namespace Junction to the NetApp SMB Volume</li>
<li>Add the SMB Shares to the Avere Cluster</li>
<li>Configure share permissions</li>
</ul>
<p>xxx ]</p>
<p>The following instructions show the commands needed to ensure that a NetApp 7-Mode volume and share can be used by an Avere cluster for SMB ACLs.</p>
<p>(To configure a system that uses Clustered Data ONTAP, read <a class="reference internal" href="#smb-ntap-clustered"><span class="std std-ref">SMB Setup - Clustered Data ONTAP</span></a>.)</p>
<p>Command examples use a volume called <span class="guilabel">/vol/myvol</span>, and an SMB share <span class="guilabel">myshare</span>.</p>
<div class="section" id="id1">
<h3>1. Configure Directory Services<a class="headerlink" href="#id1" title="Permalink to this headline">     </a></h3>
<p>[ xxx copy text from <a class="reference internal" href="#ntap-configure-ad-clustered"><span class="std std-ref">1. Configure Directory Services</span></a> - is that correct? any differences? xxx ]</p>
</div>
<div class="section" id="id2">
<h3>2. Configure SMB on the Cluster VServer<a class="headerlink" href="#id2" title="Permalink to this headline">     </a></h3>
<p>[ xxx copy of the text in <a class="reference internal" href="#ntap-vserver-config-clustered"><span class="std std-ref">2. Configure SMB on the Cluster VServer</span></a> xxx ]</p>
</div>
<div class="section" id="id3">
<h3>3. Verify the NetApp Filer Configuration<a class="headerlink" href="#id3" title="Permalink to this headline">     </a></h3>
<p>Make sure that the NetApp storage system is ready to be used with the Avere cluster for SMB.</p>
<p>All general NFS export requirements must be met - for example, NAS core filer export rules must allow root access for cluster and client-facing addresses.</p>
<p>Issue these commands on the NetApp Filer command line.</p>
<ol class="arabic">
<li><p class="first">Make sure that SMB is enabled on the NetApp filer.</p>
<p>[ xxx how to check this or enable it? <code class="docutils literal notranslate"><span class="pre">cifs</span> <span class="pre">setup</span></code> ? xxx ]</p>
</li>
<li><p class="first">Configure the filer’s storage volume to enable read, write, and root access:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exportfs</span> <span class="o">-</span><span class="n">q</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span>
<span class="n">exportfs</span> <span class="o">-</span><span class="n">p</span> <span class="n">sec</span><span class="o">=</span><span class="n">sys</span><span class="p">,</span><span class="n">rw</span><span class="p">,</span><span class="n">anon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span>
<span class="n">exportfs</span> <span class="o">-</span><span class="n">q</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span>
</pre></div>
</div>
</li>
<li><p class="first">Make sure that the volume’s security style is <span class="guilabel">NTFS</span>. Other styles are unsupported for SMB use with an Avere cluster.</p>
<p>To check the security style, use this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qtree</span> <span class="n">security</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span>
</pre></div>
</div>
<p>Use this command to set the security style to NTFS if necessary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qtree</span> <span class="n">security</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span> <span class="n">ntfs</span>
</pre></div>
</div>
</li>
<li><p class="first">Verify that the volume security allows access to <span class="guilabel">Everyone</span> with <span class="guilabel">Full Control</span>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fsecurity</span> <span class="n">show</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span>
</pre></div>
</div>
</li>
<li><p class="first">Check that the SMB share exists on the volume:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cifs</span> <span class="n">shares</span> <span class="n">myshare</span>
</pre></div>
</div>
<p>If necessary, create the share:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cifs</span> <span class="n">shares</span> <span class="o">-</span><span class="n">add</span> <span class="n">myshare</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">myvol</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the system to allow root access without checking ACLs.</p>
<p>Avere OS requires that the UNIX root user bypass ACL processing on the filer. Its SMB implementation uses the NFSv3 protocol from the Avere cluster to filers for file and directory operations, and uses SMB (version 1) from the Avere cluster to the filers for ACL operations.</p>
<p>For safety, Avere Systems recommends isolating root access to the “cluster” IP addresses and “management” IP address; do not allow root access to the client-facing IP addresses of the Avere cluster.</p>
<p>Use this setting to bypass root ACL processing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="n">cifs</span><span class="o">.</span><span class="n">nfs_root_ignore_acl</span> <span class="n">on</span>
</pre></div>
</div>
</li>
<li><p class="first">Ensure that the root user is mapped to a AD domain administrator account. Check the setting with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rdfile</span> <span class="o">/</span><span class="n">vol</span><span class="o">/</span><span class="n">vol0</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">usermap</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>If necessary, create the mapping file. This example uses a domain name of ACME:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>wrfile -a /vol/vol0/etc/usermap.cfg “ACME\Administrator == root”
</pre></div>
</div>
</li>
<li><p class="first">Check LDAP settings. Here are some commands to run on the filer to ensure that LDAP is working correctly. (Note that <code class="docutils literal notranslate"><span class="pre">priv</span> <span class="pre">set</span> <span class="pre">advanced</span></code> must be active for the <code class="docutils literal notranslate"><span class="pre">getXXbyYY</span></code> command to work.):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>priv set advanced
getXXbyYY getpwbyname_r ‘AvereUser’
getXXbyYY getpwbyuid_r &lt;pw_uid value returned from previous command&gt;
getXXbyYY getgrbygid &lt;pw_gid value returned from previous command&gt;
getXXbyYY getgrbyname ‘&lt;group name returned from previous command&gt;’
wcc -u ‘AvereUser’
wcc -s ‘AvereUser’
cifs lookup ‘AvereUser’
cifs lookup ‘&lt;GROUP_NAME&gt;
</pre></div>
</div>
</li>
<li><p class="first">Ensure that volume language settings are correct:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>volume show -vserver $&lt;VSERVER_NAME&gt; -volume &lt;VOLUME_NAME&gt; - fields language
</pre></div>
</div>
<p>The value should end in UTF-8. If it does not, use a command like the following to set the language value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vol</span> <span class="n">lang</span> <span class="o">&lt;</span><span class="n">VOLUME_NAME</span><span class="o">&gt;</span> <span class="n">C</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</pre></div>
</div>
<p>Read <a class="reference internal" href="#ntap-vol-language"><span class="std std-ref">About NetApp Filer Language Settings</span></a> for additional information.</p>
</li>
</ol>
<p>[ xxx repeat steps for additional volumes? xxx ]</p>
</div>
<div class="section" id="id4">
<h3>4. Configure Constrained Delegation in Active Directory<a class="headerlink" href="#id4" title="Permalink to this headline">     </a></h3>
<p>[ xxx need this? same as <a class="reference internal" href="#ntap-delegation"><span class="std std-ref">clustered instructions</span></a>? xxx ]</p>
</div>
<div class="section" id="id5">
<h3>5. Add the NetApp System as a Core Filer in the Avere Cluster<a class="headerlink" href="#id5" title="Permalink to this headline">     </a></h3>
<p>[ xxx need this? same as <a class="reference internal" href="#ntap-add-core-filer"><span class="std std-ref">clustered instructions</span></a>? xxx ]</p>
</div>
<div class="section" id="id6">
<h3>6. Add a Namespace Junction to the NetApp Export<a class="headerlink" href="#id6" title="Permalink to this headline">     </a></h3>
<p>[ xxx need this? same as <a class="reference internal" href="#ntap-add-junction"><span class="std std-ref">clustered instructions</span></a>? xxx ]</p>
</div>
<div class="section" id="id7">
<h3>7. Add an SMB Share on the Avere Cluster<a class="headerlink" href="#id7" title="Permalink to this headline">     </a></h3>
<p>[ xxx need this? same as <a class="reference internal" href="#ntap-add-share"><span class="std std-ref">clustered instructions</span></a>? xxx ]</p>
</div>
<div class="section" id="id8">
<h3>8. Configure Share Permissions<a class="headerlink" href="#id8" title="Permalink to this headline">     </a></h3>
<p>[ xxx need this? same as <a class="reference internal" href="#ntap-share-ace"><span class="std std-ref">clustered instructions</span></a>? xxx ]</p>
<div class="last-update docutils container">
updated 2017-11-15</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="ops_conf_index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">About Avere OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="common_tasks.html">Configuration Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings_overview.html">Avere Control Panel Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="support_overview.html">Using the Avere Control Panel Support Tab</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendixes.html">Appendixes</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontmatter.html">Copyright Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontmatter.html#trademark-information">Trademark Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontmatter.html#revision-history">Revision History</a></li>
</ul>

<h4><a href="settings_overview.html">Settings Pages</a></h4>
<ul> 
 <li><a href="settings_overview.html#creating-and-working-with-vservers">VServer section</a>
   <ul>
     <li><a href="gui_vserver_manage.html">Manage VServers</a></li>
     <li><a href="gui_vserver_details.html">VServer Details</a></li>
     <li><a href="gui_client_network.html">Client Facing Network</a></li>
     <li><a href="gui_namespace.html">Namespace</a></li>
     <li><a href="gui_export_policies.html">Export Policies</a></li>
     <li><a href="gui_export_rules.html">Export Rules</a></li>
     <li><a href="gui_nfs.html">NFS</a></li>
     <li><a href="gui_cifs.html">CIFS</a></li>
     <li><a href="gui_cifs_shares.html">CIFS Shares</a></li>
    </ul>
 </li>
 
 <li><a href="settings_overview.html#managing-core-filers">Core Filer section</a>
  <ul>
   <li><a href="gui_manage_core_filers.html">Manage Core Filers</a></li>
   <li><a href="gui_core_filer_details.html">Core Filer Details</a></li>
   <li><a href="gui_cloud_encryption_settings.html">Cloud Encryption Settings</a></li>
   <li><a href="gui_cloud_snapshots.html">Cloud Snapshots</a></li>
   <li><a href="gui_cloud_snapshot_policies.html">Cloud Snapshot Policies</a></li>
   <li><a href="gui_manage_cache_policies.html">Manage Cache Policies</a></li>
  </ul>
 </li>
 
 <li><a href="settings_overview.html#cluster-settings-overview">Cluster section</a>
  <ul>
    <li><a href="gui_cluster_general_setup.html">General Setup</a></li>
    <li><a href="gui_admin_network.html">Administrative Network</a></li>
    <li><a href="gui_cluster_networks.html">Cluster Networks</a></li>
    <li><a href="gui_proxy_config.html">Proxy Configuration</a></li>
    <li><a href="gui_fxt_nodes.html">FXT Nodes</a></li>
    <li><a href="gui_node_details.html">Node Details</a></li>
    <li><a href="gui_ha.html">High Availability</a></li>
    <li><a href="gui_monitoring_settings.html">Monitoring</a></li>
    <li><a href="gui_schedules.html">Schedules</a></li>
    <li><a href="gui_directory_services.html">Directory Services</a></li>
    <li><a href="gui_kerberos.html">Kerberos</a></li>
    <li><a href="gui_ipmi.html">IPMI</a></li>
    <li><a href="gui_support.html">Support</a></li>
    <li><a href="gui_licenses.html">Licenses</a></li>
    <li><a href="gui_cloud_credentials.html">Cloud Credentials</a></li>
    <li><a href="gui_certificates.html">Certificates</a></li>
    <li><a href="gui_kmip_servers.html">KMIP Servers</a></li>
    <li><a href="gui_vlan.html">VLAN</a></li>
  </ul>
 </li>

 <li><a href="settings_overview.html#administration-settings-overview">Administration section</a>
  <ul>
   <li><a href="gui_system_maintenance.html">System Maintenance</a></li>
   <li><a href="gui_software_update.html">Software Update</a></li>
   <li><a href="gui_users.html">Users</a></li>
   <li><a href="gui_login_services.html">Login Services</a></li>
   <li><a href="gui_hidden_alerts.html">Hidden Alerts</a></li>
  </ul>
 </li>
 
</ul>



<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="ops_conf_index.html">Avere OS Configuration Guide</a> &#187;</li> 
      </ul>
    </div>
<div style="background-color: #000;">

<div>&nbsp;</div>

<div style="text-align: right;">
	<ul style="list-style-type:none; color:#fff; padding-right: 50px; line-height:1.5em; font-size: 16px;">
		<li><strong><a href="https://azure.github.io/Avere/" target="_blank" style="color: #fff;">Legacy Documentation Home Page</a></strong>
		</li>
		<li><strong><a href="https://azure.microsoft.com/services/storage/avere-vfxt/" target="_blank" style="color: #fff;">Avere Microsoft Website</a></strong>
		</li>
	</ul>
</div>



<div style="color:#fff; padding-bottom:8px; padding-left:10px;">© 2018 Avere. All Rights Reserved. | <a href="http://www.averesystems.com/privacy-policy" style="color:#fff;">Privacy Policy</a> | <a href="http://www.averesystems.com/terms-of-use" style="color:#fff;">Terms of Use</a> 
</div>
</div>
</div>


  </body>
</html>