{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "uniqueName": {
      "type": "string",
      "maxLength": 12,
      "metadata": {
        "description": "The unique name used for the Windows 10 VM and associated resource names."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D5_v2",
      "metadata": {
        "description": "Size of the Windows 10 VM."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "Admin username on the Windows 10 VM."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Windows 10 VM."
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "The fully qualified reference to the subnet of the Avere vFXT cluster.  Example /subscriptions/SUBSCRIPTION/resourceGroups/RESOURCEGROUP/providers/Microsoft.Network/virtualNetworks/NETWORK_NAME/subnets/SUBNET_NAME."
      }
    },
    "avereManagementAddress": {
      "type": "string",
      "metadata": {
        "description": "The IP address of the Avere vFXT Management UI."
      }
    },
    "avereVServerAddress": {
      "type": "string",
      "metadata": {
        "description": "One of the Avere vFXT vServer NFS IP addresses."
      }
    },
    "avereNamespacePath": {
      "type": "string",
      "metadata": {
        "description": "The Avere vFXT namespace path."
      }
    }
  },
  "variables": {
    "uniqueName": "[parameters('uniqueName')]",
    "vmSize": "[parameters('vmSize')]",
    "adminUsername": "[parameters('adminUsername')]",
    "adminPassword": "[parameters('adminPassword')]",    
    "subnetId": "[parameters('subnetId')]",
    "avereManagementAddress": "[parameters('avereManagementAddress')]",
    "avereVServerAddress": "[parameters('avereVServerAddress')]",
    "avereNamespacePath": "[parameters('avereNamespacePath')]",
    "nicName": "[concat('vmnic-',variables('uniqueName'))]",
    "publicIPAddressName": "[concat('publicip-',variables('uniqueName'))]",
    "vmName": "[concat('vm-',variables('uniqueName'))]",
    "imageReference": {
      "publisher": "MicrosoftVisualStudio",
      "offer": "Windows",
      "sku": "Windows-10-N-x64",
      "version": "latest"
    },
    "singleQuote": "'",
    "windowsCustomScriptArguments": "[concat('$arguments = ',variables('singleQuote'),'-UserName ',variables('adminUsername'),' -avereManagementAddress ',variables('avereManagementAddress'),' -avereVServerAddress ',variables('avereVServerAddress'),' -AvereMountPath ',variables('avereNamespacePath'),variables('singleQuote'),' ; ')]",
    "windowsCustomScriptSuffix": " $inputFile = '%SYSTEMDRIVE%\\AzureData\\CustomData.bin' ; $outputFile = '%SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.ps1' ; $inputStream = New-Object System.IO.FileStream $inputFile, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read) ; $sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)) ; $sr.ReadToEnd() | Out-File($outputFile) ; Invoke-Expression('{0} {1}' -f $outputFile, $arguments) ; ",
    "windowsCustomScript": "[concat('powershell.exe -ExecutionPolicy Unrestricted -command \"', variables('windowsCustomScriptArguments'), variables('windowsCustomScriptSuffix'), '\"')]"
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Static"
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetId')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computername": "[variables('vmName')]",
          "adminUsername": "[variables('adminUsername')]",
          "adminPassword": "[variables('adminPassword')]",
          "customData": "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"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/installcustomscript')]",
      "apiVersion": "2017-12-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.9",
        "settings": {
          "commandToExecute": "[concat(variables('windowsCustomScript'),' > %SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "CLIENT_RDP_ADDRESS": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))).ipAddress]"
    }
  }
}