{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "uniqueName": {
      "type": "string",
      "metadata": {
        "description": "The unique name used for the VM and the backing storage account"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D5_v2",
      "metadata": {
        "description": "Size of the controller VM."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username on the controller VM."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Virtual Machine."
      }
    },
    "subnetRef": {
      "type": "string",
      "metadata": {
        "description": "The reference to the subnet of the Avere vFXT cluster."
      }
    },
    "avereManagementIP": {
      "type": "string",
      "metadata": {
        "description": "This is the IP address of the Avere vFXT Web UI management endpoint."
      }
    },
    "avereMountIP": {
      "type": "string",
      "metadata": {
        "description": "This is one of the NFS endpoints provided by the Avere vFXT cluster."
      }
    },
    "avereMountPath": {
      "type": "string",
      "metadata": {
        "description": "This is one of the shares provided by the Avere vFXT cluster."
      }
    }
  },
  "variables": {
    "masterEndpointDNSNamePrefix": "[parameters('uniqueName')]",
    "vmSize": "[parameters('vmSize')]",
    "adminUsername": "[parameters('adminUsername')]",
    "adminPassword": "[parameters('adminPassword')]",    
    "subnetRef": "[parameters('subnetRef')]",
    "avereManagementIP": "[parameters('avereManagementIP')]",
    "avereMountIP": "[parameters('avereMountIP')]",
    "avereMountPath": "[parameters('avereMountPath')]",
    "nicName": "vmnic",
    "publicIPAddressName": "publicip",
    "vmName": "avereclient",
    "imageReference": {
      "publisher": "MicrosoftVisualStudio",
      "offer": "Windows",
      "sku": "Windows-10-N-x64",
      "version": "latest"
    },
    "singleQuote": "'",
    "windowsCustomScriptArguments": "[concat('$arguments = ',variables('singleQuote'),'-UserName ',variables('adminUsername'),' -AvereManagementIP ',variables('avereManagementIP'),' -AvereMountIP ',variables('avereMountIP'),' -AvereMountPath ',variables('avereMountPath'),variables('singleQuote'),' ; ')]",
    "windowsCustomScriptSuffix": " $inputFile = '%SYSTEMDRIVE%\\AzureData\\CustomData.bin' ; $outputFile = '%SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.ps1' ; $inputStream = New-Object System.IO.FileStream $inputFile, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read) ; $sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)) ; $sr.ReadToEnd() | Out-File($outputFile) ; Invoke-Expression('{0} {1}' -f $outputFile, $arguments) ; ",
    "windowsCustomScript": "[concat('powershell.exe -ExecutionPolicy Unrestricted -command \"', variables('windowsCustomScriptArguments'), variables('windowsCustomScriptSuffix'), '\"')]"
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[variables('masterEndpointDNSNamePrefix')]"
        }
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computername": "[variables('vmName')]",
          "adminUsername": "[variables('adminUsername')]",
          "adminPassword": "[variables('adminPassword')]",
          "customData": "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"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/installcustomscript')]",
      "apiVersion": "2017-12-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.9",
        "settings": {
          "commandToExecute": "[concat(variables('windowsCustomScript'),' > %SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "clientAddress": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))).dnsSettings.fqdn]"
    }
  }
}