{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "uniqueName": {
      "type": "string",
      "metadata": {
        "description": "The unique name used for the VM and the backing storage account"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D5_v2",
      "metadata": {
        "description": "Size of the controller VM."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username on the controller VM."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Virtual Machine."
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "The reference to the subnet of the Avere vFXT cluster."
      }
    },
    "avereManagementIP": {
      "type": "string",
      "metadata": {
        "description": "This is the IP address of the Avere vFXT Web UI management endpoint."
      }
    },
    "avereMountIP": {
      "type": "string",
      "metadata": {
        "description": "This is one of the NFS endpoints provided by the Avere vFXT cluster."
      }
    },
    "avereMountPath": {
      "type": "string",
      "metadata": {
        "description": "This is one of the shares provided by the Avere vFXT cluster."
      }
    }
  },
  "variables": {
    "masterEndpointDNSNamePrefix": "[parameters('uniqueName')]",
    "vmSize": "[parameters('vmSize')]",
    "adminUsername": "[parameters('adminUsername')]",
    "adminPassword": "[parameters('adminPassword')]",    
    "subnetId": "[parameters('subnetId')]",
    "avereManagementIP": "[parameters('avereManagementIP')]",
    "avereMountIP": "[parameters('avereMountIP')]",
    "avereMountPath": "[parameters('avereMountPath')]",
    "nicName": "vmnic",
    "publicIPAddressName": "publicip",
    "vmName": "avereclient",
    "imageReference": {
      "publisher": "MicrosoftVisualStudio",
      "offer": "Windows",
      "sku": "Windows-10-N-x64",
      "version": "latest"
    },
    "singleQuote": "'",
    "windowsCustomScriptArguments": "[concat('$arguments = ',variables('singleQuote'),'-UserName ',variables('adminUsername'),' -AvereManagementIP ',variables('avereManagementIP'),' -AvereMountIP ',variables('avereMountIP'),' -AvereMountPath ',variables('avereMountPath'),variables('singleQuote'),' ; ')]",
    "windowsCustomScriptSuffix": " $inputFile = '%SYSTEMDRIVE%\\AzureData\\CustomData.bin' ; $outputFile = '%SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.ps1' ; $inputStream = New-Object System.IO.FileStream $inputFile, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read) ; $sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)) ; $sr.ReadToEnd() | Out-File($outputFile) ; Invoke-Expression('{0} {1}' -f $outputFile, $arguments) ; ",
    "windowsCustomScript": "[concat('powershell.exe -ExecutionPolicy Unrestricted -command \"', variables('windowsCustomScriptArguments'), variables('windowsCustomScriptSuffix'), '\"')]"
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[variables('masterEndpointDNSNamePrefix')]"
        }
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetId')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computername": "[variables('vmName')]",
          "adminUsername": "[variables('adminUsername')]",
          "adminPassword": "[variables('adminPassword')]",
          "customData": "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"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/installcustomscript')]",
      "apiVersion": "2017-12-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.9",
        "settings": {
          "commandToExecute": "[concat(variables('windowsCustomScript'),' > %SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "clientAddress": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))).dnsSettings.fqdn]"
    }
  }
}