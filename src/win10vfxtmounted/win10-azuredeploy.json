{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "uniqueName": {
      "type": "string",
      "metadata": {
        "description": "The unique name used for the VM and the backing storage account"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D5_v2",
      "metadata": {
        "description": "Size of the controller VM."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username on the controller VM."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Virtual Machine."
      }
    },
    "subnetRef": {
      "type": "string",
      "metadata": {
        "description": "The reference to the subnet of the Avere vFXT cluster."
      }
    },
    "avereManagementIP": {
      "type": "string",
      "metadata": {
        "description": "This is the IP address of the Avere vFXT Web UI management endpoint."
      }
    },
    "avereMountIP": {
      "type": "string",
      "metadata": {
        "description": "This is one of the NFS endpoints provided by the Avere vFXT cluster."
      }
    },
    "avereMountPath": {
      "type": "string",
      "metadata": {
        "description": "This is one of the shares provided by the Avere vFXT cluster."
      }
    }
  },
  "variables": {
    "masterEndpointDNSNamePrefix": "[parameters('uniqueName')]",
    "vmSize": "[parameters('vmSize')]",
    "adminUsername": "[parameters('adminUsername')]",
    "adminPassword": "[parameters('adminPassword')]",    
    "subnetRef": "[parameters('subnetRef')]",
    "avereManagementIP": "[parameters('avereManagementIP')]",
    "avereMountIP": "[parameters('avereMountIP')]",
    "avereMountPath": "[parameters('avereMountPath')]",
    "nicName": "vmnic",
    "publicIPAddressName": "publicip",
    "vmName": "avereclient",
    "imageReference": {
      "publisher": "MicrosoftVisualStudio",
      "offer": "Windows",
      "sku": "Windows-10-N-x64",
      "version": "latest"
    },
    "singleQuote": "'",
    "windowsCustomScriptArguments": "[concat('$arguments = ',variables('singleQuote'),'-UserName ',variables('adminUsername'),' -AvereManagementIP ',variables('avereManagementIP'),' -AvereMountIP ',variables('avereMountIP'),' -AvereMountPath ',variables('avereMountPath'),variables('singleQuote'),' ; ')]",
    "windowsCustomScriptSuffix": " $inputFile = '%SYSTEMDRIVE%\\AzureData\\CustomData.bin' ; $outputFile = '%SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.ps1' ; $inputStream = New-Object System.IO.FileStream $inputFile, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read) ; $sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)) ; $sr.ReadToEnd() | Out-File($outputFile) ; Invoke-Expression('{0} {1}' -f $outputFile, $arguments) ; ",
    "windowsCustomScript": "[concat('powershell.exe -ExecutionPolicy Unrestricted -command \"', variables('windowsCustomScriptArguments'), variables('windowsCustomScriptSuffix'), '\"')]"
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[variables('masterEndpointDNSNamePrefix')]"
        }
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computername": "[variables('vmName')]",
          "adminUsername": "[variables('adminUsername')]",
          "adminPassword": "[variables('adminPassword')]",
          "customData": "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"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/installcustomscript')]",
      "apiVersion": "2017-12-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.9",
        "settings": {
          "commandToExecute": "[concat(variables('windowsCustomScript'),' > %SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "clientAddress": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))).dnsSettings.fqdn]"
    }
  }
}