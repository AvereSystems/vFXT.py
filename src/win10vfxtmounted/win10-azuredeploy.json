{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "uniqueName": {
      "type": "string",
      "metadata": {
        "description": "The unique name used for the VM and the backing storage account"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D5_v2",
      "metadata": {
        "description": "Size of the controller VM."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username on the controller VM."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Virtual Machine."
      }
    },
    "subnetRef": {
      "type": "string",
      "metadata": {
        "description": "The reference to the subnet of the Avere vFXT cluster."
      }
    },
    "avereManagementIP": {
      "type": "string",
      "metadata": {
        "description": "This is the IP address of the Avere vFXT Web UI management endpoint."
      }
    },
    "avereMountIP": {
      "type": "string",
      "metadata": {
        "description": "This is one of the NFS endpoints provided by the Avere vFXT cluster."
      }
    },
    "avereMountPath": {
      "type": "string",
      "metadata": {
        "description": "This is one of the shares provided by the Avere vFXT cluster."
      }
    }
  },
  "variables": {
    "masterEndpointDNSNamePrefix": "[parameters('uniqueName')]",
    "vmSize": "[parameters('vmSize')]",
    "adminUsername": "[parameters('adminUsername')]",
    "adminPassword": "[parameters('adminPassword')]",    
    "subnetRef": "[parameters('subnetRef')]",
    "avereManagementIP": "[parameters('avereManagementIP')]",
    "avereMountIP": "[parameters('avereMountIP')]",
    "avereMountPath": "[parameters('avereMountPath')]",
    "nicName": "vmnic",
    "publicIPAddressName": "publicip",
    "vmName": "avereclient",
    "imageReference": {
      "publisher": "MicrosoftVisualStudio",
      "offer": "Windows",
      "sku": "Windows-10-N-x64",
      "version": "latest"
    },
    "singleQuote": "'",
    "windowsCustomScriptArguments": "[concat('$arguments = ',variables('singleQuote'),'-UserName ',variables('adminUsername'),' -AvereManagementIP ',variables('avereManagementIP'),' -AvereMountIP ',variables('avereMountIP'),' -AvereMountPath ',variables('avereMountPath'),variables('singleQuote'),' ; ')]",
    "windowsCustomScriptSuffix": " $inputFile = '%SYSTEMDRIVE%\\AzureData\\CustomData.bin' ; $outputFile = '%SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.ps1' ; $inputStream = New-Object System.IO.FileStream $inputFile, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read) ; $sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)) ; $sr.ReadToEnd() | Out-File($outputFile) ; Invoke-Expression('{0} {1}' -f $outputFile, $arguments) ; ",
    "windowsCustomScript": "[concat('powershell.exe -ExecutionPolicy Unrestricted -command \"', variables('windowsCustomScriptArguments'), variables('windowsCustomScriptSuffix'), '\"')]"
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[variables('masterEndpointDNSNamePrefix')]"
        }
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computername": "[variables('vmName')]",
          "adminUsername": "[variables('adminUsername')]",
          "adminPassword": "[variables('adminPassword')]",
          "customData": "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"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/installcustomscript')]",
      "apiVersion": "2017-12-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.9",
        "settings": {
          "commandToExecute": "[concat(variables('windowsCustomScript'),' > %SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "clientAddress": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))).dnsSettings.fqdn]"
    }
  }
}