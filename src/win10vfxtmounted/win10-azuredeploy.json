{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "uniqueName": {
      "type": "string",
      "maxLength": 12,
      "metadata": {
        "description": "The unique name used for the Windows 10 VM."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D5_v2",
      "metadata": {
        "description": "Size of the Windows 10 VM."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "Admin username on the Windows 10 VM."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Windows 10 VM."
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "The fully qualified reference to the subnet of the Avere vFXT cluster.  Example /subscriptions/SUBSCRIPTION/resourceGroups/RESOURCEGROUP/providers/Microsoft.Network/virtualNetworks/NETWORK_NAME/subnets/SUBNET_NAME."
      }
    },
    "avereManagementIP": {
      "type": "string",
      "metadata": {
        "description": "This is the IP address of the Avere vFXT Web UI management endpoint."
      }
    },
    "avereMountIP": {
      "type": "string",
      "metadata": {
        "description": "This is one of the NFS endpoints provided by the Avere vFXT cluster."
      }
    },
    "averevFXTPath": {
      "type": "string",
      "metadata": {
        "description": "The Avere vFXT namespace path."
      }
    }
  },
  "variables": {
    "uniqueName": "[parameters('uniqueName')]",
    "vmSize": "[parameters('vmSize')]",
    "adminUsername": "[parameters('adminUsername')]",
    "adminPassword": "[parameters('adminPassword')]",    
    "subnetId": "[parameters('subnetId')]",
    "avereManagementIP": "[parameters('avereManagementIP')]",
    "avereMountIP": "[parameters('avereMountIP')]",
    "averevFXTPath": "[parameters('averevFXTPath')]",
    "nicName": "[concat('vmnic-',variables('uniqueName'))]",
    "publicIPAddressName": "[concat('publicip-',variables('uniqueName'))]",
    "vmName": "[concat('vm-',variables('uniqueName'))]",
    "imageReference": {
      "publisher": "MicrosoftVisualStudio",
      "offer": "Windows",
      "sku": "Windows-10-N-x64",
      "version": "latest"
    },
    "singleQuote": "'",
    "windowsCustomScriptArguments": "[concat('$arguments = ',variables('singleQuote'),'-UserName ',variables('adminUsername'),' -AvereManagementIP ',variables('avereManagementIP'),' -AvereMountIP ',variables('avereMountIP'),' -AvereMountPath ',variables('averevFXTPath'),variables('singleQuote'),' ; ')]",
    "windowsCustomScriptSuffix": " $inputFile = '%SYSTEMDRIVE%\\AzureData\\CustomData.bin' ; $outputFile = '%SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.ps1' ; $inputStream = New-Object System.IO.FileStream $inputFile, ([IO.FileMode]::Open), ([IO.FileAccess]::Read), ([IO.FileShare]::Read) ; $sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($inputStream, [System.IO.Compression.CompressionMode]::Decompress)) ; $sr.ReadToEnd() | Out-File($outputFile) ; Invoke-Expression('{0} {1}' -f $outputFile, $arguments) ; ",
    "windowsCustomScript": "[concat('powershell.exe -ExecutionPolicy Unrestricted -command \"', variables('windowsCustomScriptArguments'), variables('windowsCustomScriptSuffix'), '\"')]"
  },
  "resources": [
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Static"
      }
    },
    {
      "apiVersion": "2017-10-01",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('nicName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetId')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computername": "[variables('vmName')]",
          "adminUsername": "[variables('adminUsername')]",
          "adminPassword": "[variables('adminPassword')]",
          "customData": "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"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(variables('vmName'),'/installcustomscript')]",
      "apiVersion": "2017-12-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.9",
        "settings": {
          "commandToExecute": "[concat(variables('windowsCustomScript'),' > %SYSTEMDRIVE%\\AzureData\\CustomDataSetupScript.log 2>&1')]"
        }
      }
    }
  ],
  "outputs": {
    "RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "clientRDPAddress": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))).ipAddress]"
    }
  }
}